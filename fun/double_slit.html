<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>é‡å­äºŒé‡ã‚¹ãƒªãƒƒãƒˆãƒ»ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–å­¦ç¿’ãƒšãƒ¼ã‚¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: radial-gradient(circle at top left, #1f2937 0%, #020617 45%, #020617 100%);
            color: #e5e7eb;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #sidebar {
            width: 380px;
            max-width: 100%;
            background: rgba(15, 23, 42, 0.96);
            border-right: 1px solid rgba(148, 163, 184, 0.15);
            padding: 18px 18px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 14px 18px 18px;
        }
        h1 {
            font-size: 20px;
            margin: 0 0 4px;
            letter-spacing: 0.04em;
        }
        .subtitle {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 10px;
        }
        .section-title {
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.06em;
            text-transform: uppercase;
            color: #9ca3af;
            margin-top: 4px;
            margin-bottom: 6px;
        }
        .card {
            background: radial-gradient(circle at top left, rgba(30,64,175,0.18), rgba(15,23,42,0.85));
            border-radius: 14px;
            padding: 10px 12px;
            border: 1px solid rgba(148, 163, 184, 0.22);
            box-shadow: 0 18px 40px rgba(15,23,42,0.8);
        }
        .card.soft {
            background: rgba(15, 23, 42, 0.85);
            box-shadow: 0 14px 30px rgba(15,23,42,0.7);
        }
        .card + .card {
            margin-top: 8px;
        }

        .mode-toggle {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            margin-bottom: 4px;
        }
        .mode-btn {
            flex: 1;
            border-radius: 999px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: radial-gradient(circle at top, rgba(30,64,175,0.4), rgba(15,23,42,0.9));
            padding: 6px 8px;
            font-size: 11px;
            font-weight: 500;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: #e5e7eb;
            cursor: pointer;
            transition: all 0.15s ease-out;
        }
        .mode-btn.secondary {
            background: rgba(15, 23, 42, 0.9);
            border-color: rgba(55, 65, 81, 0.8);
            color: #9ca3af;
        }
        .mode-btn.active {
            box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.9), 0 0 18px rgba(59, 130, 246, 0.55);
            color: #f9fafb;
        }
        .mode-description {
            font-size: 11px;
            color: #9ca3af;
            line-height: 1.4;
            margin-top: 4px;
        }

        .slider-group {
            margin-bottom: 6px;
        }
        .slider-label-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            font-size: 11px;
            margin-bottom: 2px;
        }
        .slider-label {
            font-weight: 500;
        }
        .slider-value {
            color: #93c5fd;
            font-variant-numeric: tabular-nums;
        }
        input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 4px;
            border-radius: 999px;
            background: linear-gradient(90deg, #1d4ed8, #6366f1);
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #e5e7eb;
            border: 2px solid #1d4ed8;
            box-shadow: 0 0 10px rgba(59,130,246,0.8);
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #e5e7eb;
            border: 2px solid #1d4ed8;
            box-shadow: 0 0 10px rgba(59,130,246,0.8);
            cursor: pointer;
        }
        input[type="range"]::-moz-range-track {
            height: 4px;
            border-radius: 999px;
            background: linear-gradient(90deg, #1d4ed8, #6366f1);
        }

        .small-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-top: 6px;
        }
        .small-row .label {
            font-size: 11px;
            color: #9ca3af;
        }
        .small-row .number {
            font-size: 11px;
            color: #bfdbfe;
            font-variant-numeric: tabular-nums;
        }

        .button-row {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }
        .ghost-btn {
            flex: 1;
            font-size: 11px;
            padding: 6px 8px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,0.5);
            background: rgba(15,23,42,0.9);
            color: #e5e7eb;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.15s ease-out;
        }
        .ghost-btn:hover {
            border-color: rgba(129,140,248,0.9);
            box-shadow: 0 0 14px rgba(79,70,229,0.6);
        }
        .ghost-btn.danger {
            border-color: rgba(248, 113, 113, 0.7);
            color: #fecaca;
        }
        .ghost-btn small {
            opacity: 0.8;
        }

        .note {
            font-size: 10px;
            color: #6b7280;
            line-height: 1.5;
            margin-top: 6px;
        }
        .tip-list {
            margin: 4px 0 0;
            padding-left: 14px;
            font-size: 11px;
            color: #9ca3af;
        }
        .tip-list li {
            margin-bottom: 2px;
        }

        #canvas-container {
            flex: 1;
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.27);
            background: radial-gradient(circle at top, rgba(55,65,81,0.65), #020617 42%, #000 80%);
            box-shadow: 0 24px 60px rgba(15,23,42,0.95);
            position: relative;
            padding: 10px 10px 12px;
            display: flex;
            flex-direction: column;
        }
        #screen {
            flex: 1;
            border-radius: 12px;
            background: #020617;
            border: 1px solid rgba(31,41,55,0.9);
            image-rendering: pixelated;
        }
        #canvas-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 6px;
            padding: 0 2px;
        }
        #mode-label {
            font-size: 12px;
            font-weight: 500;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #9ca3af;
        }
        #derived-info {
            font-size: 10px;
            color: #9ca3af;
            font-variant-numeric: tabular-nums;
        }
        #footer-text {
            margin-top: 6px;
            font-size: 11px;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
        }
        #footer-text strong {
            color: #9ca3af;
        }

        @media (max-width: 900px) {
            body {
                flex-direction: column;
                height: auto;
            }
            #sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid rgba(148, 163, 184, 0.15);
                max-height: 62vh;
                overflow-y: auto;
            }
            #main {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div>
            <h1>é‡å­äºŒé‡ã‚¹ãƒªãƒƒãƒˆå®Ÿé¨“</h1>
            <div class="subtitle">
                æ³¢ã¨ç²’å­ã®äºŒé‡æ€§ãƒ»å¹²æ¸‰ãƒ»ãƒ‡ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ã‚¹ã‚’<br>ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§ç›´æ„Ÿçš„ã«ä½“æ„Ÿã§ãã¾ã™ã€‚
            </div>
        </div>

        <div class="card">
            <div class="section-title">è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰</div>
            <div class="mode-toggle">
                <button class="mode-btn active" id="wave-mode-btn">
                    æ³¢ã¨ã—ã¦è¡¨ç¤º<br><small>å¹²æ¸‰ç¸ã®å¼·åº¦åˆ†å¸ƒ</small>
                </button>
                <button class="mode-btn secondary" id="particle-mode-btn">
                    ç²’å­ã®æ‰“ã¡è¾¼ã¿<br><small>ï¼‘ç™ºãšã¤è“„ç©</small>
                </button>
            </div>
            <div class="mode-description" id="mode-description">
                ã€Œæ³¢ã¨ã—ã¦è¡¨ç¤ºã€ã§ã¯ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ä¸Šã®æ˜ã‚‹ã•ãŒ<br>
                æ³¢ã®å¹²æ¸‰ã«ã‚ˆã‚‹å¼·åº¦ï¼ˆç¢ºç‡ã®é«˜ä½ï¼‰ã‚’è¡¨ã—ã¾ã™ã€‚
            </div>
        </div>

        <div class="card soft">
            <div class="section-title">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</div>

            <div class="slider-group">
                <div class="slider-label-row">
                    <span class="slider-label">æ³¢é•·ï¼ˆç›¸å¯¾å˜ä½ï¼‰</span>
                    <span class="slider-value" id="lambda-value">0.70</span>
                </div>
                <input type="range" id="lambda-slider" min="0.30" max="1.00" step="0.01" value="0.70">
            </div>

            <div class="slider-group">
                <div class="slider-label-row">
                    <span class="slider-label">ã‚¹ãƒªãƒƒãƒˆé–“éš” dï¼ˆç›¸å¯¾å˜ä½ï¼‰</span>
                    <span class="slider-value" id="d-value">2.50</span>
                </div>
                <input type="range" id="d-slider" min="1.00" max="5.00" step="0.05" value="2.50">
            </div>

            <div class="slider-group">
                <div class="slider-label-row">
                    <span class="slider-label">ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã¾ã§ã®è·é›¢ Lï¼ˆç›¸å¯¾å˜ä½ï¼‰</span>
                    <span class="slider-value" id="L-value">2.00</span>
                </div>
                <input type="range" id="L-slider" min="1.00" max="5.00" step="0.05" value="2.00">
            </div>

            <div class="slider-group">
                <div class="slider-label-row">
                    <span class="slider-label">ãƒ‡ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ã‚¹ï¼ˆã©ã¡ã‚‰ã‚’é€šã£ãŸã‹ã®ã€Œæƒ…å ±ã€ï¼‰</span>
                    <span class="slider-value" id="decoherence-value">0.00</span>
                </div>
                <input type="range" id="decoherence-slider" min="0" max="1" step="0.01" value="0">
            </div>

            <div class="small-row">
                <div class="label">ç²’å­ãƒ¢ãƒ¼ãƒ‰ï¼šï¼‘ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ãŸã‚Šã®ç²’å­æ•°</div>
                <div class="number"><span id="shots-value">50</span> ç™º</div>
            </div>
            <input type="range" id="shots-slider" min="5" max="300" step="5" value="50">

            <div class="button-row">
                <button class="ghost-btn" id="pause-btn">
                    â¯ <span id="pause-label">ä¸€æ™‚åœæ­¢</span>
                </button>
                <button class="ghost-btn danger" id="reset-btn">
                    ğŸ§¹ <small>ç²’å­ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ</small>
                </button>
            </div>

            <div class="note">
                â€»ã“ã“ã§ã®å˜ä½ã¯ã€Œç›¸å¯¾å˜ä½ã€ã§ã™ã€‚å®Ÿéš›ã®å®Ÿé¨“ã§ã¯ nmï¼ˆæ³¢é•·ï¼‰ã€Î¼mï¼ˆã‚¹ãƒªãƒƒãƒˆå¹…ãƒ»é–“éš”ï¼‰ã€mï¼ˆè·é›¢ï¼‰ãªã©ã«ãªã‚Šã¾ã™ãŒã€<br>
                å¹²æ¸‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¦‹ã‚„ã™ãã™ã‚‹ãŸã‚ã«ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã—ã¦ã„ã¾ã™ã€‚
            </div>
        </div>

        <div class="card soft">
            <div class="section-title">è¦‹ã©ã“ã‚</div>
            <ul class="tip-list">
                <li>ãƒ‡ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ã‚¹ã‚’ 0 â†’ 1 ã«å‹•ã‹ã™ã¨ã€å¹²æ¸‰ç¸ãŒæ¶ˆãˆã¦ã¼ã‚“ã‚„ã‚Šã—ãŸï¼‘ã¤ã®å±±ã«ãªã‚Šã¾ã™ï¼ˆã©ã®ã‚¹ãƒªãƒƒãƒˆã‚’é€šã£ãŸã‹ã€Œåˆ†ã‹ã‚‹ã€ã¨å¹²æ¸‰ã—ãªã„ï¼‰ã€‚</li>
                <li>ç²’å­ãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€ï¼‘ç™ºï¼‘ç™ºã¯ãƒ©ãƒ³ãƒ€ãƒ ã ãŒã€ãŸãã•ã‚“æ‰“ã¡è¾¼ã‚€ã¨æ³¢ã®å¼·åº¦åˆ†å¸ƒã©ãŠã‚Šã®æ¨¡æ§˜ãŒæµ®ã‹ã³ä¸ŠãŒã‚Šã¾ã™ã€‚</li>
                <li>æ³¢é•·ã‚’é•·ãã™ã‚‹ã¨ç¸ã®é–“éš”ãŒåºƒãŒã‚Šã€ã‚¹ãƒªãƒƒãƒˆé–“éš”ã‚’åºƒã’ã‚‹ã¨ç¸ãŒç´°ã‹ããªã£ã¦ã„ãã¾ã™ã€‚</li>
            </ul>
        </div>
    </div>

    <div id="main">
        <div id="canvas-container">
            <div id="canvas-header">
                <div id="mode-label">æ³¢ã®å¼·åº¦ãƒ‘ã‚¿ãƒ¼ãƒ³</div>
                <div id="derived-info">
                    ä¸­å¿ƒä»˜è¿‘ã®ç¸ã®é–“éš”ï¼ˆç›®å®‰ï¼‰: <span id="fringe-spacing">â€“</span>ï¼ˆç›¸å¯¾ä½ç½®ï¼‰
                </div>
            </div>
            <canvas id="screen" width="960" height="520"></canvas>
            <div id="footer-text">
                <span>å·¦å´ï¼šäºŒé‡ã‚¹ãƒªãƒƒãƒˆã€€â†’ã€€å³å´ï¼šè¦³æ¸¬ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆæ˜ã‚‹ã•ï¼æ¤œå‡ºç¢ºç‡ï¼‰</span>
                <span><strong>å­¦ç¿’ã®ãƒã‚¤ãƒ³ãƒˆï¼š</strong> æ³¢ã¨ç²’å­ã®äºŒé‡æ€§ / å¹²æ¸‰ / ãƒ‡ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ã‚¹</span>
            </div>
        </div>
    </div>

    <script>
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã¨ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
        const canvas = document.getElementById('screen');
        const ctx = canvas.getContext('2d');

        // UIè¦ç´ 
        const waveModeBtn = document.getElementById('wave-mode-btn');
        const particleModeBtn = document.getElementById('particle-mode-btn');
        const modeDescriptionEl = document.getElementById('mode-description');
        const modeLabelEl = document.getElementById('mode-label');

        const lambdaSlider = document.getElementById('lambda-slider');
        const dSlider = document.getElementById('d-slider');
        const LSlider = document.getElementById('L-slider');
        const decoherenceSlider = document.getElementById('decoherence-slider');
        const shotsSlider = document.getElementById('shots-slider');

        const lambdaValueEl = document.getElementById('lambda-value');
        const dValueEl = document.getElementById('d-value');
        const LValueEl = document.getElementById('L-value');
        const decoherenceValueEl = document.getElementById('decoherence-value');
        const shotsValueEl = document.getElementById('shots-value');
        const fringeSpacingEl = document.getElementById('fringe-spacing');

        const pauseBtn = document.getElementById('pause-btn');
        const pauseLabel = document.getElementById('pause-label');
        const resetBtn = document.getElementById('reset-btn');

        // ãƒ¢ãƒ‡ãƒ«ãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆç›¸å¯¾å˜ä½ï¼‰
        const params = {
            wavelength: parseFloat(lambdaSlider.value),   // Î»
            slitSeparation: parseFloat(dSlider.value),   // d
            screenDistance: parseFloat(LSlider.value),   // L
            slitWidth: 0.7,                              // å˜ã‚¹ãƒªãƒƒãƒˆå¹…ï¼ˆç›¸å¯¾ã€‚å›ºå®šï¼‰
            decoherence: parseFloat(decoherenceSlider.value), // 0ã€œ1
            mode: 'wave',      // 'wave' or 'particles'
            shotsPerFrame: parseInt(shotsSlider.value, 10),
            running: true
        };

        // è¨ˆç®—ç”¨ãƒãƒƒãƒ•ã‚¡
        let intensityArray = new Float32Array(canvas.width);
        let cdfArray = new Float32Array(canvas.width);
        let maxIntensity = 1;
        let totalShots = 0;

        // ç”»é¢ä¸Šã®åŠåˆ†ã®å¹…ã‚’ç›¸å¯¾è·é›¢ã«ãƒãƒƒãƒ”ãƒ³ã‚°
        const SCREEN_HALF_WIDTH = 4.0; // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³å·¦å³ç«¯ã¾ã§ã®ã€Œç›¸å¯¾ä½ç½®ã€

        function updateLabels() {
            lambdaValueEl.textContent = params.wavelength.toFixed(2);
            dValueEl.textContent = params.slitSeparation.toFixed(2);
            LValueEl.textContent = params.screenDistance.toFixed(2);
            decoherenceValueEl.textContent = params.decoherence.toFixed(2);
            shotsValueEl.textContent = params.shotsPerFrame.toString();
        }

        function computePattern() {
            const w = canvas.width;
            const lambda = params.wavelength;
            const d = params.slitSeparation;
            const L = params.screenDistance;
            const a = params.slitWidth;
            const decoh = params.decoherence;

            let maxI = 0;
            let sumI = 0;

            for (let i = 0; i < w; i++) {
                const xRel = ((i / (w - 1)) * 2 - 1) * SCREEN_HALF_WIDTH; // -W..+W

                const theta = Math.atan2(xRel, L); // ç›¸å¯¾çš„ãªè§’åº¦
                const k = 2 * Math.PI / lambda;
                const delta = k * d * Math.sin(theta); // 2ã‚¹ãƒªãƒƒãƒˆé–“ã®ä½ç›¸å·®

                const beta = Math.PI * a * Math.sin(theta) / lambda;
                let envelope;
                if (Math.abs(beta) < 1e-6) {
                    envelope = 1.0;
                } else {
                    envelope = Math.sin(beta) / beta; // sinc
                }
                const I1 = envelope * envelope; // å˜ã‚¹ãƒªãƒƒãƒˆã®å›æŠ˜åŒ…çµ¡

                // å¹²æ¸‰ã‚ã‚Šã®ã¨ã (2ã‚¹ãƒªãƒƒãƒˆ, ã‚³ãƒ’ãƒ¼ãƒ¬ãƒ³ãƒˆ)
                const interference = Math.cos(delta / 2);
                const Iinterf = 4 * I1 * interference * interference;

                // å¹²æ¸‰ãªã—ï¼ˆå„ã‚¹ãƒªãƒƒãƒˆç‹¬ç«‹ã«è¶³ã—åˆã‚ã›ã‚‹ï¼‰
                const Ino = 2 * I1;

                const I = (1 - decoh) * Iinterf + decoh * Ino;

                intensityArray[i] = I;
                if (I > maxI) maxI = I;
                sumI += I;
            }

            maxIntensity = maxI > 0 ? maxI : 1;

            // CDFã‚’æ§‹ç¯‰ï¼ˆç²’å­ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
            let cumulative = 0;
            const norm = sumI > 0 ? 1 / sumI : 0;
            for (let i = 0; i < w; i++) {
                cumulative += intensityArray[i] * norm;
                cdfArray[i] = cumulative;
            }
            if (cdfArray[w - 1] === 0) {
                // ä¸‡ä¸€å…¨ã¦ã‚¼ãƒ­ãªã‚‰å‡ç­‰åˆ†å¸ƒ
                for (let i = 0; i < w; i++) {
                    cdfArray[i] = (i + 1) / w;
                }
            }

            updateFringeEstimate();
        }

        function updateFringeEstimate() {
            const lambda = params.wavelength;
            const d = params.slitSeparation;
            const L = params.screenDistance;

            if (d === 0) {
                fringeSpacingEl.textContent = 'â€“';
                return;
            }
            // äºŒé‡ã‚¹ãƒªãƒƒãƒˆã®åŸºæœ¬å¼ Î”x ~ Î» L / d ã‚’ç›¸å¯¾å˜ä½ã§ãã®ã¾ã¾
            let fringe = (lambda * L) / d;
            if (!isFinite(fringe) || fringe <= 0) {
                fringeSpacingEl.textContent = 'â€“';
                return;
            }
            // ç”»é¢å¹…ã¨ã®é–¢ä¿‚ã‚’è»½ãã‚¹ã‚±ãƒ¼ãƒ«ã—ã¦ç›®å®‰è¡¨ç¤º
            fringeSpacingEl.textContent = fringe.toFixed(2);
        }

        function drawWavePattern() {
            const w = canvas.width;
            const h = canvas.height;
            const image = ctx.createImageData(w, h);
            const data = image.data;

            for (let x = 0; x < w; x++) {
                const I = intensityArray[x] / maxIntensity;
                const brightness = Math.max(0, Math.min(1, I));
                const gamma = Math.pow(brightness, 0.7); // å°‘ã—æ˜ã‚‹ã‚ã«

                const r = Math.floor(255 * gamma);
                const g = Math.floor(255 * Math.pow(brightness, 0.5));
                const b = Math.floor(255 * (0.4 + 0.6 * brightness));

                for (let y = 0; y < h; y++) {
                    const idx = (y * w + x) * 4;
                    data[idx] = r;
                    data[idx + 1] = g;
                    data[idx + 2] = b;
                    data[idx + 3] = 255;
                }
            }

            ctx.putImageData(image, 0, 0);
            totalShots = 0;
        }

        function clearParticles() {
            const w = canvas.width;
            const h = canvas.height;

            const gradient = ctx.createLinearGradient(0, 0, 0, h);
            gradient.addColorStop(0, '#020617');
            gradient.addColorStop(0.4, '#020617');
            gradient.addColorStop(1.0, '#000000');

            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, w, h);

            totalShots = 0;
        }

        function sampleXIndexFromCDF() {
            const w = canvas.width;
            const u = Math.random();
            // äºŒåˆ†æ¢ç´¢
            let low = 0;
            let high = w - 1;

            while (low < high) {
                const mid = (low + high) >> 1;
                if (u <= cdfArray[mid]) {
                    high = mid;
                } else {
                    low = mid + 1;
                }
            }
            return low;
        }

        function drawOneParticle() {
            const xIndex = sampleXIndexFromCDF();
            const jitter = (Math.random() - 0.5); // ãƒ”ã‚¯ã‚»ãƒ«å†…ã§ãƒ©ãƒ³ãƒ€ãƒ ã«
            const x = xIndex + jitter;

            const h = canvas.height;
            const y = (0.15 + 0.7 * Math.random()) * h; // ç”»é¢ä¸­å¤®ä»˜è¿‘ã«æ•£ã‚‰ã™

            const alpha = 0.3 + 0.7 * Math.random();
            ctx.fillStyle = `rgba(96, 165, 250, ${alpha.toFixed(2)})`;

            const size = 1.2 + 1.0 * Math.random();
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            ctx.fill();

            totalShots++;
        }

        function onParamsChanged(resetParticleView = true) {
            computePattern();
            if (params.mode === 'wave') {
                drawWavePattern();
            } else {
                if (resetParticleView) {
                    clearParticles();
                }
            }
        }

        function setMode(newMode) {
            if (params.mode === newMode) return;

            params.mode = newMode;
            if (newMode === 'wave') {
                waveModeBtn.classList.add('active');
                waveModeBtn.classList.remove('secondary');
                particleModeBtn.classList.remove('active');
                particleModeBtn.classList.add('secondary');
                modeDescriptionEl.innerHTML = 'ã€Œæ³¢ã¨ã—ã¦è¡¨ç¤ºã€ã§ã¯ã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã®æ˜ã‚‹ã•ãŒ<br>æ³¢ã®å¹²æ¸‰ã«ã‚ˆã‚‹å¼·åº¦ï¼ˆç¢ºç‡ã®é«˜ã•ï¼‰ã‚’è¡¨ã—ã¾ã™ã€‚';
                modeLabelEl.textContent = 'æ³¢ã®å¼·åº¦ãƒ‘ã‚¿ãƒ¼ãƒ³';
                pauseBtn.disabled = true;
                pauseBtn.style.opacity = 0.5;
                pauseLabel.textContent = 'ä¸€æ™‚åœæ­¢';
                params.running = true;
                drawWavePattern();
            } else {
                waveModeBtn.classList.remove('active');
                waveModeBtn.classList.add('secondary');
                particleModeBtn.classList.add('active');
                particleModeBtn.classList.remove('secondary');
                modeDescriptionEl.innerHTML = 'ã€Œç²’å­ã®æ‰“ã¡è¾¼ã¿ã€ã§ã¯ã€ï¼‘ç™ºï¼‘ç™ºã¯ãƒ©ãƒ³ãƒ€ãƒ ã§ã™ãŒã€<br>å¤šæ•°æ‰“ã¡è¾¼ã‚€ã¨æ³¢ã®å¹²æ¸‰ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæµ®ã‹ã³ä¸ŠãŒã‚Šã¾ã™ã€‚';
                modeLabelEl.textContent = 'ç²’å­ã®æ¤œå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆçµ±è¨ˆï¼‰';
                pauseBtn.disabled = false;
                pauseBtn.style.opacity = 1;
                params.running = true;
                pauseLabel.textContent = 'ä¸€æ™‚åœæ­¢';
                clearParticles();
            }
        }

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
        function animate() {
            if (params.mode === 'particles' && params.running) {
                const n = params.shotsPerFrame;
                for (let i = 0; i < n; i++) {
                    drawOneParticle();
                }
            }
            requestAnimationFrame(animate);
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        lambdaSlider.addEventListener('input', (e) => {
            params.wavelength = parseFloat(e.target.value);
            updateLabels();
            onParamsChanged(true);
        });

        dSlider.addEventListener('input', (e) => {
            params.slitSeparation = parseFloat(e.target.value);
            updateLabels();
            onParamsChanged(true);
        });

        LSlider.addEventListener('input', (e) => {
            params.screenDistance = parseFloat(e.target.value);
            updateLabels();
            onParamsChanged(true);
        });

        decoherenceSlider.addEventListener('input', (e) => {
            params.decoherence = parseFloat(e.target.value);
            updateLabels();
            onParamsChanged(true);
        });

        shotsSlider.addEventListener('input', (e) => {
            params.shotsPerFrame = parseInt(e.target.value, 10);
            updateLabels();
        });

        waveModeBtn.addEventListener('click', () => setMode('wave'));
        particleModeBtn.addEventListener('click', () => setMode('particles'));

        pauseBtn.addEventListener('click', () => {
            if (params.mode !== 'particles') return;
            params.running = !params.running;
            pauseLabel.textContent = params.running ? 'ä¸€æ™‚åœæ­¢' : 'å†é–‹';
        });

        resetBtn.addEventListener('click', () => {
            if (params.mode === 'wave') {
                drawWavePattern();
            } else {
                clearParticles();
            }
        });

        // åˆæœŸåŒ–
        updateLabels();
        computePattern();
        drawWavePattern();
        requestAnimationFrame(animate);
    </script>
</body>
</html>
